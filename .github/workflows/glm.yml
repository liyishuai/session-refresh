name: GLM

on:
  schedule:
    - cron: 0 * * * *
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: temurin
          cache: maven

      - name: Build and run
        id: glm
        env:
          ZAI_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ZAI_BASE_URL: https://open.bigmodel.cn/api/coding/paas/v4/
        run: |
          cd trigger-glm
          mvn package -q
          set +e
          output=$(java -jar target/trigger-glm-1.0.0.jar 2>&1)
          set -e
          echo "$output"
          SUCCESS=$(echo "$output" | jq -r '.success // false')
          GLM_ERROR=$(echo "$output" | jq -r '.code // empty')
          GLM_ERROR_MSG=$(echo "$output" | jq -r '.message // empty')
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "error=$GLM_ERROR" >> $GITHUB_OUTPUT
          echo "message=$GLM_ERROR_MSG" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages

      - name: Fetch template from master
        run: |
          git checkout origin/master -- templates/README.mustache

      - name: Update status with jq
        env:
          SUCCESS: ${{ steps.glm.outputs.success }}
          MESSAGE: ${{ steps.glm.outputs.message }}
        run: |
          [ -f status.json ] || echo '{"services":[]}' > status.json
          jq --arg key "glm" \
             --arg name "GLM" \
             --arg badge "${{ github.server_url }}/${{ github.repository }}/actions/workflows/glm.yml/badge.svg" \
             --arg usage "https://bigmodel.cn/usercenter/glm-coding/usage" \
             --argjson success "$SUCCESS" \
             --arg timestamp "$(date +'%Y-%m-%d %H:%M:%S')" \
             --arg job_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
             --arg message "$MESSAGE" \
             '(.services |= ([{
               key: $key, name: $name, badge_url: $badge, usage_url: $usage,
               success: $success, timestamp: $timestamp, job_url: $job_url, message: $message
             }] + map(select(.key != $key))))' status.json > tmp.json && mv tmp.json status.json

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: latest

      - name: Render README with mustache
        run: npx mustache status.json templates/README.mustache > README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json README.md
          if ! git diff --staged --quiet; then
            git commit -m "Update GLM status"
            git push origin gh-pages
          fi

      - name: Fail on error
        env:
          SUCCESS: ${{ steps.glm.outputs.success }}
          ERROR: ${{ steps.glm.outputs.error }}
          MESSAGE: ${{ steps.glm.outputs.message }}
        if: env.SUCCESS != 'true'
        run: |
          if [ "$ERROR" != "1308" ]; then
            echo "::error title=GLM API Error::Error code: $ERROR, Message: $MESSAGE"
            exit ${ERROR:-1}
          fi
